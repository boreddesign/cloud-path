# Print Path Architecture

## Overview

This application visualizes 3D construction printing toolpaths by converting building element centerlines into bead centerlines (print paths) and lofting them with bead profiles.

---

## Core Concept

### **Elements vs Beads**

**Elements** = Building components (walls, windows, doors)
- Defined by centerlines in CAD
- NOT lofted directly
- Used only as input to generate bead paths

**Beads** = Printed material paths
- Generated by offsetting element centerlines
- These ARE lofted with bead profile
- Represent actual print head movement

---

## Data Flow

```
┌─────────────────────────────────────────────────────────────┐
│ 1. INPUT: CAD Geometry (Wall Centerlines)                  │
│    - DXF/JSON file with line segments                      │
│    - Represents center of walls                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. PLANFORMER: Element → Bead Conversion                   │
│    - Join segments into continuous paths                   │
│    - Offset by (wallThickness - nozzleWidth) / 2          │
│    - Generate BOTH inner and outer bead centerlines        │
│    - Fillet sharp corners (1" radius)                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. LOFTING: Bead Centerlines → 3D Geometry                │
│    - Loft bead profile along bead centerlines              │
│    - Stack layers vertically (layer height)                │
│    - Generate mesh for visualization                       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. OUTPUT: 3D Visualization                                │
│    - Wall centerline (gray - reference only)               │
│    - Bead centerlines (orange/red - lofted)                │
│    - 3D bead geometry (white meshes)                       │
└─────────────────────────────────────────────────────────────┘
```

---

## Key Components

### **1. Planformer (`src/utils/wallOffset.js`)**

**Purpose**: Convert element centerlines to bead centerlines

**Functions**:
- `joinSegments()` - Connect segments into continuous paths
- `offsetPath()` - Create parallel offset curves
- `filletCorners()` - Round sharp corners
- `computeOffsets()` - Main orchestrator

**Input**: Wall centerline segments
**Output**: Bead centerline points (inner + outer)

**Example**:
```javascript
// Wall centerline (12" thick wall)
segments = [
  { type: 'line', start: [0, 0], end: [100, 0] },
  { type: 'line', start: [100, 0], end: [100, 50] }
]

// Bead centerlines (offset ±5")
beadCenterlines = computeOffsets(segments, {
  offsetDistance: 5,  // (12" - 2") / 2
  filletRadius: 1.0
})

// Result: 2 offset curves (inner + outer)
```

---

### **2. Lofting (`src/utils/geometry.js`)**

**Purpose**: Create 3D geometry from bead centerlines

**Function**: `loftGeometry(profile, path)`

**Input**: 
- `profile` - 2D bead cross-section (pill shape)
- `path` - 3D bead centerline points

**Output**: Three.js BufferGeometry

**Process**:
1. Convert profile to 3D (z=0)
2. For each point along path:
   - Calculate Frenet-Serret frame (tangent, normal, binormal)
   - Transform profile to path orientation
   - Generate vertices
3. Connect vertices into triangular mesh

---

### **3. Visualization (`src/components/Scene3D.jsx`)**

**Purpose**: Render geometry in 3D viewer

**Rendered Elements**:
- **Wall centerline** (gray line) - Reference only, NOT lofted
- **Bead centerlines** (orange/red lines) - These ARE lofted
- **Bead geometry** (white meshes) - 3D lofted beads
- **Profile preview** (wireframe) - Shows bead cross-section

**View Modes**:
- 3D view - Isometric perspective
- Plan view - Top-down orthographic

---

## Configuration

### **Wall to Bead Conversion**

```javascript
// Wall properties
wallThickness = 12"      // Total wall thickness
nozzleWidth = 2"         // Print nozzle width
wallHeight = 120"        // Wall height (10 ft)

// Bead offset calculation
offsetDistance = (wallThickness - nozzleWidth) / 2
              = (12" - 2") / 2
              = 5"

// Result: Two beads, 10" apart (10" + 2" nozzle = 12" wall)
```

### **Layer Stacking**

```javascript
layerHeight = 1"         // Height per layer
wallHeight = 120"        // Total wall height
previewMode = true       // Use 10x spacing for preview

// Layer calculation
effectiveLayerHeight = previewMode ? layerHeight * 10 : layerHeight
numLayers = Math.ceil(wallHeight / effectiveLayerHeight)
           = Math.ceil(120" / 10") = 12 layers
```

---

## File Structure

```
src/
├── utils/
│   ├── wallOffset.js       # Planformer: Element → Bead conversion
│   ├── geometry.js         # Lofting: Bead → 3D geometry
│   └── cadParser.js        # CAD file parsing
├── components/
│   ├── Scene3D.jsx         # 3D visualization
│   ├── ControlPanel.jsx    # UI controls
│   ├── StackedLoftedMesh.jsx  # Multi-layer geometry
│   └── PathLine.jsx        # Path visualization
└── profile-bead.json       # Default bead profile (pill shape)
```

---

## Important Rules

### ❌ **DO NOT Loft Element Centerlines**

Element centerlines (walls, windows, doors) are **reference geometry only**.

```javascript
// WRONG ❌
<LoftedMesh profile={beadProfile} path={wallCenterline} />

// CORRECT ✓
const beadCenterlines = computeOffsets(wallCenterline, config)
beadCenterlines.forEach(bead => {
  <LoftedMesh profile={beadProfile} path={bead.points} />
})
```

### ✓ **ONLY Loft Bead Centerlines**

Bead centerlines are the **actual print paths** that should be lofted.

---

## Visualization Colors

| Element | Color | Meaning |
|---------|-------|---------|
| Wall centerline | Gray (#888888) | Reference only |
| Outer bead centerline | Orange (#ff570a) | Lofted |
| Inner bead centerline | Red (#841c26) | Lofted |
| Bead geometry | White (#FFFEFF) | 3D mesh |

---

## Future Extensions

### **Planformer Enhancements**

The Planformer module will eventually handle:
- **Windows**: Create openings in wall beads
- **Doors**: Create openings with lintels
- **Corners**: Join walls at intersections
- **Reinforcement**: Add structural elements
- **Utilities**: Embed conduits and pipes

### **Element Types**

```javascript
// Future architecture
elements = [
  { type: 'wall', centerline: [...], thickness: 12 },
  { type: 'window', position: [...], size: [36, 48] },
  { type: 'door', position: [...], size: [36, 80] }
]

// Planformer converts all elements → bead centerlines
beadCenterlines = planformer.process(elements)

// Loft ONLY the bead centerlines
beadCenterlines.forEach(bead => {
  loftGeometry(beadProfile, bead.points)
})
```

---

## Summary

**Key Principle**: 
> Elements (walls) define WHAT to build.  
> Beads define HOW to print it.  
> Only beads are lofted and visualized.

**Workflow**:
1. Load element centerlines (walls) from CAD
2. Planformer converts to bead centerlines (offset curves)
3. Loft bead profile along bead centerlines
4. Visualize 3D bead geometry

**Result**: 
- Accurate preview of construction printing toolpaths
- Clear separation between design geometry and print geometry
- Extensible architecture for complex building elements

